<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Sonar Viewer</title>
  <style>
    html,body { height:100%; margin:0; background:black; color:#0f0; }
    canvas { display:block; margin:0 auto; background:black; }
    #info { position:fixed; left:8px; top:8px; color:#0f0; font-family:monospace; }
  </style>
</head>
<body>
<div id="info">Status: <span id="status">disconnected</span></div>
<canvas id="c" width="900" height="900"></canvas>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const statusSpan = document.getElementById('status');

// CONFIG
const SERVER_HOST = window.location.host; // will be yourservice.onrender.com
const SERVER = (location.protocol === 'https:' ? 'wss://' : 'ws://') + SERVER_HOST + '/ws/viewer';
const MAX_RANGE_M = 5.0;        // visual range in meters
const CONE_HALF_ANGLE_DEG = 30; // half cone angle
const PX_PER_M = canvas.width / (MAX_RANGE_M * 2);

function drawScene(detection) {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const cx = canvas.width/2;
  const cy = canvas.height*0.9;
  const r_px = MAX_RANGE_M * PX_PER_M;
  const startAngle = (Math.PI/2) + (CONE_HALF_ANGLE_DEG * Math.PI/180);
  const endAngle = (Math.PI/2) - (CONE_HALF_ANGLE_DEG * Math.PI/180);

  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.arc(cx, cy, r_px, endAngle, startAngle, true);
  ctx.closePath();
  const g = ctx.createRadialGradient(cx,cy,10,cx,cy,r_px);
  g.addColorStop(0, "rgba(0,255,0,0.25)");
  g.addColorStop(1, "rgba(0,64,0,0.02)");
  ctx.fillStyle = g;
  ctx.fill();

  ctx.strokeStyle = "rgba(0,255,0,0.6)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.lineTo(cx + r_px*Math.sin(CONE_HALF_ANGLE_DEG*Math.PI/180), cy - r_px*Math.cos(CONE_HALF_ANGLE_DEG*Math.PI/180));
  ctx.moveTo(cx,cy);
  ctx.lineTo(cx - r_px*Math.sin(CONE_HALF_ANGLE_DEG*Math.PI/180), cy - r_px*Math.cos(CONE_HALF_ANGLE_DEG*Math.PI/180));
  ctx.stroke();

  if (detection && detection.distance_m !== null) {
    const dist = detection.distance_m;
    const angle_deg = detection.angle_deg || 0;
    if (dist <= MAX_RANGE_M && Math.abs(angle_deg) <= CONE_HALF_ANGLE_DEG) {
      const angle_rad = (angle_deg) * Math.PI/180.0;
      const x = cx + (dist * PX_PER_M)*Math.sin(angle_rad);
      const y = cy - (dist * PX_PER_M)*Math.cos(angle_rad);
      ctx.beginPath();
      ctx.fillStyle = "red";
      ctx.arc(x,y,8,0,Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "#0f0";
      ctx.font = "14px monospace";
      ctx.fillText(`${dist.toFixed(2)} m`, x+12, y-6);
    }
  }

  ctx.beginPath();
  ctx.fillStyle = "#0f0";
  ctx.arc(cx,cy,6,0,Math.PI*2);
  ctx.fill();
}

let ws;
function connect() {
  ws = new WebSocket(SERVER);
  ws.onopen = ()=> {
    statusSpan.textContent = "connected";
    setInterval(()=>{ try{ ws.send('ping'); } catch(e){} }, 20000);
  };
  ws.onmessage = (ev)=> {
    try {
      const payload = JSON.parse(ev.data);
      drawScene(payload);
    } catch(e) {}
  };
  ws.onclose = ()=> { statusSpan.textContent = "disconnected"; setTimeout(connect, 2000); };
  ws.onerror = (e)=> { statusSpan.textContent = "error"; console.error(e); ws.close(); };
}
connect();
drawScene(null);
</script>
</body>
</html>
